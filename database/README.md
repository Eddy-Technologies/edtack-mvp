# EdTack Database Management

This directory contains database-related files for the EdTack MVP project. The system is designed to work with **Supabase's native migration and seeding system**.

## ğŸ—‚ï¸ Directory Structure

```
database/
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ db.js         # ğŸ¯ BARE BONES SCRIPT (handover to Supabase)
â”œâ”€â”€ tables/           # Source table schemas (.sql files)
â”œâ”€â”€ seeds/            # Source seed data (.sql files)
â””â”€â”€ README.md         # This file

supabase/
â”œâ”€â”€ migrations/       # Generated by db:reset (timestamped .sql files)
â””â”€â”€ seed.sql          # Generated by db:seed (consolidated file)
```

## ğŸš€ Commands

| Command | What it does |
|---------|--------------|
| `pnpm db:reset` | 1. Generate migrations in `/supabase/migrations/` <br> 2. Run `supabase db reset` |
| `pnpm db:seed` | 1. Generate `/supabase/seed.sql` from sources <br> 2. Run via `psql` |

## ğŸ¯ How it Works

### `pnpm db:reset`:
1. **Reads** all files from `database/tables/` in dependency order
2. **Generates** timestamped migration files in `supabase/migrations/`
3. **Runs** `supabase db reset` (which uses those migrations)

### `pnpm db:seed`:
1. **Combines** files from `database/seeds/` into single `supabase/seed.sql`
2. **Runs** via `psql` directly (Supabase CLI doesn't have a seed command)

## ğŸ“‹ Source Files

### Tables (25+ files)
Located in `database/tables/`:
- **Base**: `roles.sql`, `level_types.sql`, `codes.sql`
- **Users**: `user_infos.sql`, `user_roles.sql`, `user_credits.sql`
- **Content**: `characters.sql`, `notes.sql`, `questions.sql`
- **Commerce**: `products.sql`, `orders.sql`
- **Functions**: `functions.sql`

### Seeds (3 files)
Located in `database/seeds/`:
- `all_seeds.sql` - System data (roles, codes, products)
- `characters.sql` - Character data
- `admin_user.sql` - Admin user (not used, manual creation recommended)

## ğŸ—ï¸ Architecture

### âœ… What we do:
- **Generate** properly ordered migrations for Supabase
- **Combine** seed files into single consolidated file
- **Handover** to Supabase CLI for all database operations

### âŒ What we don't do:
- Execute SQL directly (Supabase handles this)
- Manage dependencies manually (timestamps handle order)
- Generate TypeScript types (use `supabase gen types` manually if needed)
- Create admin users (do this manually via Supabase dashboard or Auth API)

## ğŸ”§ Migration Order

The script generates migrations in this dependency order:
1. Base tables (roles, level_types, codes, subjects)
2. User tables (user_infos, user_roles, user_credits)
3. Content tables (questions, characters, notes)
4. Commerce tables (products, orders)
5. Functions and triggers

## ğŸ’¡ Usage Tips

**For development:**
```bash
pnpm db:reset     # Reset database with latest schema
pnpm db:seed      # Add seed data
```

**For production:**
- Use `supabase db reset` only for fresh deployments
- Use `supabase db seed` to populate reference data
- Create admin users via Supabase Auth API or Dashboard

## ğŸ› ï¸ Troubleshooting

### Common Issues
1. **Migrations fail**: Check dependency order in `db.js`
2. **Seed fails**: Verify files exist in `database/seeds/`
3. **Supabase not found**: Ensure Supabase CLI is installed and project is linked

### Manual Operations
- **Generate types**: `supabase gen types typescript --local`
- **Create admin user**: Use Supabase Dashboard â†’ Authentication â†’ Users
- **View migrations**: Check `supabase/migrations/` directory

---

This is a **bare-bones system** that generates files for Supabase and lets Supabase handle all database operations natively.